schema: '2.0'
stages:
  train:
    cmd: brainways-reg-model train
    deps:
    - path: data/real.zip
      md5: 8238c090f19acdceea62e322b026c060
      size: 84937521
    - path: data/synth.zip
      md5: 6318577a216c85d2fb9ed36860092172
      size: 698700770
    - path: src/brainways_reg_model/model/dataset.py
      md5: 69c8d3dbfed142fc75c98f161bcbe3cf
      size: 5557
    - path: src/brainways_reg_model/model/model.py
      md5: 2bf70e5302bfb7f7281119b1f1e5011e
      size: 9599
    - path: src/brainways_reg_model/model/train.py
      md5: 5b38b8fb83a45ff2d91e70a332e0c349
      size: 4384
    params:
      params.yaml:
        default:
          seed: 1234
          model:
            backbone: resnet50
            outputs:
            - ap
            - hemisphere
            - valid
          data:
            atlas:
              name: whs_sd_rat_39um
              brainglobe: true
              exclude_regions:
              - 76
              - 42
              - 41
            image_size:
            - 128
            - 128
            batch_size: 32
            label_params:
              ap:
                n_classes: 512
                limits:
                - 122
                - 799
              rot_frontal:
                n_classes: 10
                limits:
                - -15
                - 15
              rot_horizontal:
                n_classes: 7
                limits:
                - -7
                - 7
              rot_sagittal:
                n_classes: 7
                limits:
                - -7
                - 7
              hemisphere:
                n_classes: 3
                label_names:
                - both
                - right
                - left
              valid:
                n_classes: 2
                label_names:
                - no
                - yes
          opt:
            train_bn: true
            milestones:
            - 5
            - 10
            lr: 0.001
            lr_scheduler_gamma: 0.5
            weight_decay: 0.0001
            max_epochs: 25
            monitor:
              metric: val_ap_acc_10
              mode: max
            train_confidence: false
        reg: {}
    outs:
    - path: trained_model/synth/logs
      md5: 2b7368e207a2560237afee179c8a50da.dir
      size: 63782
      nfiles: 2
    - path: trained_model/synth/model.ckpt
      md5: 47c50fd2546732b54b8874a53fe63ff4
      size: 290350579
  finetune:
    cmd: python -m brainways_reg_model.model.finetune
    deps:
    - path: data/real.zip
      md5: 27ba991686a79c051e72ffc21365a7a7
      size: 23485852
    - path: src/brainways_reg_model/model/dataset.py
      md5: 87aa7a958f54380ae068fa54c422f648
      size: 5374
    - path: src/brainways_reg_model/model/finetune.py
      md5: 33279e7a739a973703c063741305824e
      size: 2234
    - path: src/brainways_reg_model/model/model.py
      md5: d611c12a56152f9bb79d4ec847353334
      size: 9426
    - path: trained_model/synth/model.ckpt
      md5: 1d8d7f21eeeaa825d0adb1b9e2b54826
      size: 102745603
    params:
      params.yaml:
        default:
          seed: 1234
          model:
            backbone: resnet50
            outputs:
            - ap
            - hemisphere
          data:
            atlas:
              name: whs_sd_rat_39um
              brainglobe: true
              exclude_regions:
              - 76
              - 42
              - 41
            image_size:
            - 128
            - 128
            batch_size: 32
            label_params:
              ap:
                n_classes: 512
                limits:
                - 122
                - 799
              rot_frontal:
                n_classes: 10
                limits:
                - -15
                - 15
              rot_horizontal:
                n_classes: 7
                limits:
                - -7
                - 7
              rot_sagittal:
                n_classes: 7
                limits:
                - -7
                - 7
              hemisphere:
                n_classes: 3
                label_names:
                - both
                - right
                - left
          opt:
            train_bn: true
            milestones:
            - 5
            - 10
            lr: 0.001
            lr_scheduler_gamma: 0.5
            weight_decay: 0.0001
            max_epochs: 25
            monitor:
              metric: val_ap_acc_10
              mode: max
            train_confidence: false
        finetune:
          opt:
            train_bn: true
            lr: 0.001
            lr_scheduler_gamma: 0.5
            weight_decay: 0.001
            milestones:
            - 50
            - 100
            max_epochs: 120
            monitor:
              metric: val_ap_acc_10
              mode: max
            train_confidence: true
        reg: {}
    outs:
    - path: trained_model/real/logs
      md5: 7209176dbf89aa12de0a4d50f9ef7370.dir
      size: 54189
      nfiles: 2
    - path: trained_model/real/model.ckpt
      md5: 001372b4053ff735d5af1ed2592ff62e
      size: 102745859
  eval:
    cmd: brainways-reg-model evaluate --checkpoint trained_model/synth/model.ckpt
      --output trained_model/synth/scores.json
    deps:
    - path: src/brainways_reg_model/model/evaluate.py
      md5: 952b08b4ad57ee43039436a876b5b0f8
      size: 2219
    - path: trained_model/synth/model.ckpt
      md5: 7d036263edae306be7a0fa043739a970
      size: 290348219
    outs:
    - path: trained_model/synth/scores.json
      md5: 5e3578328a0f928954d2b292efacf6f8
      size: 181
  eval-finetune:
    cmd: brainways-reg-model evaluate
    deps:
    - path: src/brainways_reg_model/model/evaluate.py
      md5: 952b08b4ad57ee43039436a876b5b0f8
      size: 2219
    - path: trained_model/real/model.ckpt
      md5: 9038a9539e62423a19918ddeddf190cb
      size: 290427247
    outs:
    - path: trained_model/real/scores.json
      md5: 74601acd8046493d8e85f194021d5118
      size: 262
  train-synth:
    cmd: brainways-reg-model train --config reg --train-data data/synth.zip --output
      trained_model/synth
    deps:
    - path: data/real.zip
      md5: 0f068e9fb0d1a0d6112f53340dec7ae6
      size: 2129199043
    - path: data/synth.zip
      md5: 6318577a216c85d2fb9ed36860092172
      size: 698700770
    - path: src/brainways_reg_model/model/dataset.py
      md5: 51a2fff0dd82cc78f8d3226e45d0fcdf
      size: 6002
    - path: src/brainways_reg_model/model/model.py
      md5: 40575833d3e327f0a1aab1713af08d2f
      size: 10677
    - path: src/brainways_reg_model/model/train.py
      md5: 405ee91300cdb8da667fa54a3942b85d
      size: 4839
    params:
      params.yaml:
        default:
          seed: 1234
          model:
            backbone: resnet50
            outputs:
            - ap
            - hemisphere
            - valid
          data:
            atlas:
              name: whs_sd_rat_39um
              brainglobe: true
              exclude_regions:
              - 76
              - 42
              - 41
            image_size:
            - 128
            - 128
            batch_size: 128
            label_params:
              ap:
                n_classes: 512
                limits:
                - 122
                - 799
              rot_frontal:
                n_classes: 10
                limits:
                - -15
                - 15
              rot_horizontal:
                n_classes: 7
                limits:
                - -7
                - 7
              rot_sagittal:
                n_classes: 7
                limits:
                - -7
                - 7
              hemisphere:
                n_classes: 3
                label_names:
                - both
                - right
                - left
              valid:
                n_classes: 2
                label_names:
                - no
                - yes
          opt:
            train_bn: true
            milestones:
            - 10
            - 20
            lr: 0.001
            lr_scheduler_gamma: 0.5
            weight_decay: 0.0001
            max_epochs: 30
            monitor:
              metric: val_ap_mae
              mode: min
            train_confidence: false
            check_val_every_n_epoch: 5
        reg: {}
    outs:
    - path: trained_model/synth/logs
      md5: d7ccd165ffbbc4e5fae8ff25c4e7ba00.dir
      size: 26661
      nfiles: 2
    - path: trained_model/synth/model.ckpt
      md5: 7d036263edae306be7a0fa043739a970
      size: 290348219
  train-real:
    cmd: brainways-reg-model train --config finetune --train-data data/real.zip --output
      trained_model/real --pretrained-checkpoint trained_model/synth/model.ckpt
    deps:
    - path: data/real.zip
      md5: 0f068e9fb0d1a0d6112f53340dec7ae6
      size: 2129199043
    - path: src/brainways_reg_model/model/dataset.py
      md5: 51a2fff0dd82cc78f8d3226e45d0fcdf
      size: 6002
    - path: src/brainways_reg_model/model/model.py
      md5: 40575833d3e327f0a1aab1713af08d2f
      size: 10677
    - path: src/brainways_reg_model/model/train.py
      md5: 405ee91300cdb8da667fa54a3942b85d
      size: 4839
    - path: trained_model/synth/model.ckpt
      md5: 7d036263edae306be7a0fa043739a970
      size: 290348219
    params:
      params.yaml:
        default:
          seed: 1234
          model:
            backbone: resnet50
            outputs:
            - ap
            - hemisphere
            - valid
          data:
            atlas:
              name: whs_sd_rat_39um
              brainglobe: true
              exclude_regions:
              - 76
              - 42
              - 41
            image_size:
            - 128
            - 128
            batch_size: 128
            label_params:
              ap:
                n_classes: 512
                limits:
                - 122
                - 799
              rot_frontal:
                n_classes: 10
                limits:
                - -15
                - 15
              rot_horizontal:
                n_classes: 7
                limits:
                - -7
                - 7
              rot_sagittal:
                n_classes: 7
                limits:
                - -7
                - 7
              hemisphere:
                n_classes: 3
                label_names:
                - both
                - right
                - left
              valid:
                n_classes: 2
                label_names:
                - no
                - yes
          opt:
            train_bn: true
            milestones:
            - 10
            - 20
            lr: 0.001
            lr_scheduler_gamma: 0.5
            weight_decay: 0.0001
            max_epochs: 30
            monitor:
              metric: val_ap_mae
              mode: min
            train_confidence: false
            check_val_every_n_epoch: 5
        finetune:
          opt:
            weight_decay: 0.001
            max_epochs: 100
            train_confidence: true
            check_val_every_n_epoch: 10
        reg: {}
    outs:
    - path: trained_model/real/logs
      md5: 416e88cd24f85ccc82a5133d93fc8a8d.dir
      size: 20977
      nfiles: 2
    - path: trained_model/real/model.ckpt
      md5: 9038a9539e62423a19918ddeddf190cb
      size: 290427247
