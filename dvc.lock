schema: '2.0'
stages:
  train:
    cmd: brainways-reg-model train
    deps:
    - path: data/real.zip
      md5: 8238c090f19acdceea62e322b026c060
      size: 84937521
    - path: data/synth.zip
      md5: 6318577a216c85d2fb9ed36860092172
      size: 698700770
    - path: src/brainways_reg_model/model/dataset.py
      md5: 69c8d3dbfed142fc75c98f161bcbe3cf
      size: 5557
    - path: src/brainways_reg_model/model/model.py
      md5: 2bf70e5302bfb7f7281119b1f1e5011e
      size: 9599
    - path: src/brainways_reg_model/model/train.py
      md5: 5b38b8fb83a45ff2d91e70a332e0c349
      size: 4384
    params:
      params.yaml:
        default:
          seed: 1234
          model:
            backbone: resnet50
            outputs:
            - ap
            - hemisphere
            - valid
          data:
            atlas:
              name: whs_sd_rat_39um
              brainglobe: true
              exclude_regions:
              - 76
              - 42
              - 41
            image_size:
            - 128
            - 128
            batch_size: 32
            label_params:
              ap:
                n_classes: 512
                limits:
                - 122
                - 799
              rot_frontal:
                n_classes: 10
                limits:
                - -15
                - 15
              rot_horizontal:
                n_classes: 7
                limits:
                - -7
                - 7
              rot_sagittal:
                n_classes: 7
                limits:
                - -7
                - 7
              hemisphere:
                n_classes: 3
                label_names:
                - both
                - right
                - left
              valid:
                n_classes: 2
                label_names:
                - no
                - yes
          opt:
            train_bn: true
            milestones:
            - 5
            - 10
            lr: 0.001
            lr_scheduler_gamma: 0.5
            weight_decay: 0.0001
            max_epochs: 25
            monitor:
              metric: val_ap_acc_10
              mode: max
            train_confidence: false
        reg: {}
    outs:
    - path: trained_model/synth/logs
      md5: 2b7368e207a2560237afee179c8a50da.dir
      size: 63782
      nfiles: 2
    - path: trained_model/synth/model.ckpt
      md5: 47c50fd2546732b54b8874a53fe63ff4
      size: 290350579
  finetune:
    cmd: python -m brainways_reg_model.model.finetune
    deps:
    - path: data/real.zip
      md5: 27ba991686a79c051e72ffc21365a7a7
      size: 23485852
    - path: src/brainways_reg_model/model/dataset.py
      md5: 87aa7a958f54380ae068fa54c422f648
      size: 5374
    - path: src/brainways_reg_model/model/finetune.py
      md5: 33279e7a739a973703c063741305824e
      size: 2234
    - path: src/brainways_reg_model/model/model.py
      md5: d611c12a56152f9bb79d4ec847353334
      size: 9426
    - path: trained_model/synth/model.ckpt
      md5: 1d8d7f21eeeaa825d0adb1b9e2b54826
      size: 102745603
    params:
      params.yaml:
        default:
          seed: 1234
          model:
            backbone: resnet50
            outputs:
            - ap
            - hemisphere
          data:
            atlas:
              name: whs_sd_rat_39um
              brainglobe: true
              exclude_regions:
              - 76
              - 42
              - 41
            image_size:
            - 128
            - 128
            batch_size: 32
            label_params:
              ap:
                n_classes: 512
                limits:
                - 122
                - 799
              rot_frontal:
                n_classes: 10
                limits:
                - -15
                - 15
              rot_horizontal:
                n_classes: 7
                limits:
                - -7
                - 7
              rot_sagittal:
                n_classes: 7
                limits:
                - -7
                - 7
              hemisphere:
                n_classes: 3
                label_names:
                - both
                - right
                - left
          opt:
            train_bn: true
            milestones:
            - 5
            - 10
            lr: 0.001
            lr_scheduler_gamma: 0.5
            weight_decay: 0.0001
            max_epochs: 25
            monitor:
              metric: val_ap_acc_10
              mode: max
            train_confidence: false
        finetune:
          opt:
            train_bn: true
            lr: 0.001
            lr_scheduler_gamma: 0.5
            weight_decay: 0.001
            milestones:
            - 50
            - 100
            max_epochs: 120
            monitor:
              metric: val_ap_acc_10
              mode: max
            train_confidence: true
        reg: {}
    outs:
    - path: trained_model/real/logs
      md5: 7209176dbf89aa12de0a4d50f9ef7370.dir
      size: 54189
      nfiles: 2
    - path: trained_model/real/model.ckpt
      md5: 001372b4053ff735d5af1ed2592ff62e
      size: 102745859
  eval:
    cmd: brainways-reg-model evaluate --checkpoint trained_model/synth/model.ckpt
      --output trained_model/synth/scores.json
    deps:
    - path: src/brainways_reg_model/model/evaluate.py
      md5: 363ae50aad5064af2339c07caa8ea9dc
      size: 2276
    - path: trained_model/synth/model.ckpt
      md5: 5e41af85adda890329024de167df9290
      size: 290350579
    outs:
    - path: trained_model/synth/scores.json
      md5: 182851d6474c980b763f249e0404213d
      size: 181
  eval-finetune:
    cmd: python -m brainways_reg_model.model.evaluate trained_model/real/model.ckpt
      trained_model/real/scores.json
    deps:
    - path: src/brainways_reg_model/model/evaluate.py
      md5: c91d71ac2f0424726abda89203d501f1
      size: 1961
    - path: trained_model/real/model.ckpt
      md5: 001372b4053ff735d5af1ed2592ff62e
      size: 102745859
    outs:
    - path: trained_model/real/scores.json
      md5: 705d4168b6b5e03201fcea500078f1e5
      size: 509
